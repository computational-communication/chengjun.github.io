Do("slider","dialog","effects",function(){$(function(){$.post_withck=function(y,A,B,z){if($.isFunction(A)){z=B;B=A;A={}}return $.ajax({type:"POST",url:y,data:$.extend(A,{ck:get_cookie("ck")}),success:B,dataType:z||"text"})};var o=false,v="",u=dui.Dialog(),a="#ffc",n=$(".widget-tips"),w=$(".sp-fn-box"),e=$("#sp-user"),b=$("#room-rename"),k=b.next(),f=$(".box-close"),h=$(".room-del"),s=$("#new-room"),i=$(".widgets-box"),g=$(".widgets-slider .lnk-add"),m=$('.nav-items li > a:has("em") span'),l=$('.nav-items li > a:has("em") em, .street-editor'),p=$("body").attr("id"),c=$("body").data("site-url"),x=$("body").data("site-url-for-json"),d=$("#current-room").data("url-for-json"),t=$("#room-rename").val(),r="#content .main",q="<em></em>添加成功",j='<span class="txt-added">正在添加</span>';templ_box_loading='<p class="box-loading">正在载入...</p>',isModEmpty=$(".main .sort").length?false:true,showBox=function(y){w.children().hide();e.css("margin-top","0");w.slideDown(y).append(templ_box_loading);setTimeout(function(){$(".box-loading").remove();if($.browser.msie&&$.browser.version==="8.0"){w.children().show()}else{w.children().fadeIn()}i.hide().eq(0).show();if(isRoomEmpty){b.focus()}},y)},DoCreateRoom=function(y){$.post_withck(x+"/create_room",function(z){if(!z.error){location.href=z.room}else{u.set({width:300,content:z.error,buttons:["confirm"]}).open()}},"json")},roomRename=function(y){m.text(y);$.post_withck(renameURL,{name:y})};i.slider();if(!isSiteFirstEnter&&isRoomEmpty&&isModEmpty){showBox(800)}if(location.pathname.split("/").length===3){renameURL=x+"room_settings/"}else{renameURL=d+"settings/"}n.click(function(){var y=$(this).attr("id").split("-")[1];n.removeClass("selected");$(this).addClass("selected");i.hide();$("#widget-"+y).fadeIn()});h.click(function(z){z.preventDefault();isModEmpty=!$(".main .sort").length&&!$("#div_archives").length?true:false;var y=d+"/settings/delete";if(isModEmpty){u.set({width:300,content:"确定要删除房间？",buttons:[{text:"确定",method:function(A){A.close();$.post_withck(y,{name:t},function(){location.href=c})}},"cancel"]}).open()}else{u.set({width:300,content:"需要先把空间里的应用模块清理掉 再删除房间",buttons:["confirm"]}).open()}});s.click(function(y){y.preventDefault();$.post_withck(x+"create_room_check",function(z){if(z.code=="go_ahead"){DoCreateRoom()}else{if(z.code=="reach_max_limit"){u.set({width:300,content:z.error,buttons:["confirm"]}).open()}else{if(z.code=="dou_not_enough"){u.set({width:300,content:z.error,buttons:[{text:"我知道了",method:function(A){A.close()}}]}).open()}else{if(z.code=="need_confirm"){u.set({width:300,content:z.error,buttons:[{text:"确定增加",method:function(A){A.close();DoCreateRoom(1)}},"cancel"]}).open()}else{if(z.code=="cant_admin_dou"){u.set({width:280,content:z.error,buttons:[{text:"我知道了",method:function(A){A.close()}}]}).open()}}}}}},"json")});l.click(function(y){y.preventDefault();if(w.is(":hidden")){showBox(800);$(this).addClass("current")}else{w.hide();$(this).removeClass();e.css("margin-top","-100px")}});b.keyup(function(z){if(z.keyCode===13){var y=z.target.value;roomRename(y)}});k.click(function(z){var y=b.val();roomRename(y)});f.click(function(y){y.preventDefault();$(this).parent().hide();w.hide();l.removeClass();e.css("margin-top","-100px")});g.click(function(z){z.preventDefault();var y=this,A=z.target.id.split("-")[1];if(!$(this).data("adding")){$(this).data("adding",1);$.post_withck(d+"widgets",{kind:A},function(B){if(!B.error){$(y).hide().after(j);$(r).prepend(B.html);$(r+" .mod:first").css("backgroundColor",a).animate({backgroundColor:"white"},1500);$(y).next().html(q);setTimeout(function(){$(y).show().next().remove().end().data("adding",0)},10000)}else{u.set({width:300,content:B.error,buttons:["confirm"]}).open()}},"json")}});if(isSiteFirstEnter){(function(){var B=$("body").attr("id"),y='<div class="user-guide"><em></em><h1>{TITLE}</h1><span>{PAGE}</span><p>{CONTENT}</p><a id="{ID}" href="#" class="lnk-add">{BUTTON}</a></div>',A={title:"小站设置",page:"1/2",content:"16套主题模板，让你的小站与众不同。",button:"知道了",id:"next-step"},z={title:"房间改名和添加应用",page:"2/2",content:"不仅可以随心搭配多种精彩的应用，还可以通过拖拽标签来改变房间顺序。",button:"立即开启",id:"close"};$("#room-admin").append(y.replace("{TITLE}",A.title).replace("{PAGE}",A.page).replace("{CONTENT}",A.content).replace("{BUTTON}",A.button).replace("{ID}",A.id));$("#next-step").live("click",function(C){C.preventDefault();$(this).parent().remove();$(".nav-items .on").append(y.replace("{TITLE}",z.title).replace("{PAGE}",z.page).replace("{CONTENT}",z.content).replace("{BUTTON}",z.button).replace("{ID}",z.id));$(".user-guide").css("left","4px")});$("#close").live("click",function(C){C.preventDefault();$(this).parent().remove();showBox(800);$.post_withck(x+"/tips",{t:"setting"})})})()}})});