(function(){var c=$.browser.msie&&parseInt($.browser.version)===8,a="模块标题不能为空",d=function(g,f){var e=g.parents(".mod"),h=e.find(".hd"),i=h.find("a.a_lnk_mod_setting");if(f==="on"){g.slideDown("fast");h.addClass("stat-active");i.addClass("on");i.html("关闭设置")}else{g.slideUp("fast",function(){if(c){$(this).parent().find(".fix_ie8_bug").remove();$('<div class="fix_ie8_bug" style="height:1px;overflow:hidden;margin-top:-1px;"></div>').insertBefore(this)}});g.find("form")[0].reset();e.find(".setting-panel .attn").html("");h.removeClass("stat-active");i.removeClass("on");i.html("设置")}},b=function(e){e.submit(function(i){i.preventDefault();var h=$(this),g,j=h.find("input[name=name]"),f=h.attr("action");if($.trim(j.val())===""){g=j.next();if(g.length&&g.hasClass("attn")){g.html(a)}else{$(' <span class="attn">'+a+"</span>").insertAfter(j)}return}h.find("input:submit").attr("disabled",true);$.post_withck(f,Douban.get_form_fields(h),$.proxy(function(o){var k,n=this,p,l,m,o=(typeof o==="object")?o:$.parseJSON(o);n.find("input:submit").attr("disabled",false);if(o.r){m=n.prev();if(m.length&&m.hasClass("attn")){m.html(o.error)}else{$('<div class="attn">'+o.error+"</div>").insertBefore(n)}return}l=n.parents(".mod");if(o.html===""){l.fadeOut(function(){$(this).remove()});return}p=$("input[name=name]",n).val();l.find(".bd").html(o.html);if(typeof l.attr("archives")=="undefined"){l.find(".hd h2 span:eq(0)").html(p)}else{l.find(".hd span:eq(1) a").text(p)}d(n.parents(".setting-panel"),"off")},h))})};Douban.init_cancel_setting_panel=function(f){d($(this).parents(".setting-panel"),"off")};Douban.init_archive_mod=function(h){var g=$(this);var f=g.attr("href");var j=f.indexOf("unarchive")<0;var i="确定要将"+g.attr("screen_name")+'"'+g.attr("title")+'"'+(j?'存档？<br/><span style="color:#999">提示：存档后可在房间底部的“更多应用”内找到。<span>':"恢复到"+g.attr("room_name")+"?");dui.Dialog({width:360,iframe:true,content:i,buttons:[{text:"确定",method:function(e){e.close();$.post_withck(f,{},function(l){var k=(typeof l==="string")?$.parseJSON(l):l;if(k.r===1){dui.Dialog({width:360,iframe:true,content:k.error,buttons:["confirm"]}).open();return}g.parents(".mod").fadeOut(function(){$(this).remove()});if(j){var m=g.parents(".mod").siblings("div#div_archives");if(m&&m.css("display")=="none"){m.fadeIn()}}})}},"cancel"]}).open();return};Douban.init_delete_mod=function(h){var g=$(this),i=g.attr("title")||g.text(),f=g.attr("href");if(confirm(i)){$.post_withck(f,{},$.proxy(function(k){var j=(typeof k==="string")?$.parseJSON(k):k;if(j.r===1){var e=j.error?j.error:"删除失败。";dui.Dialog({width:300,iframe:true,content:e,buttons:["confirm"]}).open();return}this.parents(".mod").fadeOut(function(){$(this).remove()})},g))}};Douban.init_lnk_mod_setting=function(k){var i=$(this),g=i.parents(".mod"),j=g.find(".hd").first(),f="/j/widget/"+g.attr("id").split("-")[0]+"/"+g.attr("id").split("-")[1]+"/settings",h=g.find(".setting-panel");if(i.hasClass("lnk_setting_loading")){return}if(i.hasClass("on")){d(h,"off")}else{if(h.length===0){$('<div class="setting-panel"></div>').insertAfter(j);h=g.find(".setting-panel")}i.addClass("lnk_setting_loading");h.html('<div class="loading">下载中......</div>');$.getJSON(f,$.proxy(function(e){this.html(e.html);i.removeClass("lnk_setting_loading");b(this.find("form"));d(h,"on")},h))}}})();